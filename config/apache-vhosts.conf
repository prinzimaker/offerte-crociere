# =============================================================================
# Configurazione Apache VirtualHost per MSC API Proxy
#
# File di esempio â€” da adattare al server di produzione.
# Copiare le sezioni nei file di configurazione Apache appropriati.
#
# Percorsi da verificare:
# - DocumentRoot: /var/www/mscapi/api/public  e  /var/www/mscapi/log/public
# - Certificati SSL: adattare ai percorsi reali (Let's Encrypt o altro)
# =============================================================================

# --- API Server: mscapi.fttn.it ---
<VirtualHost *:80>
    ServerName mscapi.fttn.it
    Redirect permanent / https://mscapi.fttn.it/
</VirtualHost>

<VirtualHost *:443>
    ServerName mscapi.fttn.it
    DocumentRoot /var/www/mscapi/api/public

    # SSL (adattare ai percorsi reali)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/mscapi.fttn.it/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/mscapi.fttn.it/privkey.pem

    <Directory /var/www/mscapi/api/public>
        AllowOverride All
        Require all granted

        # Assicura che l'header Authorization venga passato a PHP
        SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    </Directory>

    # Impedisci l'accesso ai file fuori dalla document root
    <DirectoryMatch "/var/www/mscapi/(shared|sql|config)">
        Require all denied
    </DirectoryMatch>

    # Log Apache
    ErrorLog ${APACHE_LOG_DIR}/mscapi_error.log
    CustomLog ${APACHE_LOG_DIR}/mscapi_access.log combined
</VirtualHost>


# --- Log Viewer: msclog.fttn.it ---
<VirtualHost *:80>
    ServerName msclog.fttn.it
    Redirect permanent / https://msclog.fttn.it/
</VirtualHost>

<VirtualHost *:443>
    ServerName msclog.fttn.it
    DocumentRoot /var/www/mscapi/log/public

    # SSL (adattare ai percorsi reali)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/msclog.fttn.it/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/msclog.fttn.it/privkey.pem

    <Directory /var/www/mscapi/log/public>
        AllowOverride All
        Require all granted
    </Directory>

    # Impedisci l'accesso ai template e src
    <DirectoryMatch "/var/www/mscapi/log/(src|templates)">
        Require all denied
    </DirectoryMatch>

    # Impedisci l'accesso ai file condivisi
    <DirectoryMatch "/var/www/mscapi/(shared|sql|config)">
        Require all denied
    </DirectoryMatch>

    # Log Apache
    ErrorLog ${APACHE_LOG_DIR}/msclog_error.log
    CustomLog ${APACHE_LOG_DIR}/msclog_access.log combined
</VirtualHost>
